<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Coleta de Dados Terapêutica - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { margin-bottom: 20px; }
        canvas { max-width: 600px; margin: 20px 0; }
        #dadosLista { margin-top: 20px; font-size: 14px; }
        button { margin: 5px; }
    </style>
</head>
<body>
    <h1>Coleta de Dados Terapêutica</h1>
    <p>Adicione dados de uma nova sessão e veja o gráfico de evolução da Escala de Frustração. Dados são salvos localmente no navegador.</p>

    <!-- Formulário para adicionar sessão -->
    <form id="formSessao">
        <label>Sessão (número único): <input type="number" id="sessao" min="1" required></label><br>
        <label>Escala de Frustração (0-4): <input type="number" id="frustracao" min="0" max="4" required></label><br>
        <label>Freq. Deitar (0-3): <input type="number" id="freqDeitar" min="0" max="3" required></label><br>
        <label>Tempo Deitada (min): <input type="number" id="tempoDeitada" min="0" required></label><br>
        <label>Uso Tela (0-3): <input type="number" id="usoTela" min="0" max="3" required></label><br>
        <label>Mandos Totais: <input type="number" id="mandosTotais" min="0" required></label><br>
        <button type="submit">Adicionar Sessão</button>
        <button type="button" id="limparDados">Limpar Todos os Dados</button>
    </form>

    <!-- Canvas para o gráfico -->
    <canvas id="graficoFrustracao"></canvas>

    <!-- Lista de dados atuais -->
    <div id="dadosLista">
        <h3>Dados Atuais:</h3>
        <pre id="dadosTexto">Nenhum dado carregado.</pre>
    </div>

    <script>
        let dadosSessoes = []; // Array para armazenar dados
        let chartInstance = null; // Instância do gráfico para gerenciamento

        // Carrega dados do localStorage na inicialização
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('dadosSessoes');
            if (dadosSalvos) {
                try {
                    dadosSessoes = JSON.parse(dadosSalvos);
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                    dadosSessoes = [];
                }
            }
            atualizarLista();
            atualizarGrafico();
        }

        // Salva dados no localStorage
        function salvarDados() {
            try {
                localStorage.setItem('dadosSessoes', JSON.stringify(dadosSessoes));
            } catch (e) {
                console.error('Erro ao salvar dados:', e);
            }
        }

        // Atualiza a lista de dados na tela
        function atualizarLista() {
            const texto = dadosSessoes.length > 0 
                ? dadosSessoes.map(d => `Sessão ${d.sessao}: Frustração=${d.frustracao}, Freq.Deitar=${d.freqDeitar}, TempoDeitada=${d.tempoDeitada}, UsoTela=${d.usoTela}, Mandos=${d.mandosTotais}`).join('\n')
                : 'Nenhum dado.';
            document.getElementById('dadosTexto').textContent = texto;
        }

        // Atualiza o gráfico
        function atualizarGrafico() {
            try {
                // Destrói a instância anterior se existir
                if (chartInstance) {
                    chartInstance.destroy();
                }

                const ctx = document.getElementById('graficoFrustracao').getContext('2d');
                const labels = dadosSessoes.map(d => `Sessão ${d.sessao}`);
                const dataFrustracao = dadosSessoes.map(d => d.frustracao);

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Escala de Frustração (0-4)',
                            data: dataFrustracao,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, max: 4 }
                        }
                    }
                });
            } catch (e) {
                console.error('Erro ao atualizar gráfico:', e);
                alert('Erro ao gerar gráfico. Verifique os dados.');
            }
        }

        // Evento para adicionar nova sessão
        document.getElementById('formSessao').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Coleta valores
            const sessao = parseInt(document.getElementById('sessao').value);
            const frustracao = parseInt(document.getElementById('frustracao').value);
            const freqDeitar = parseInt(document.getElementById('freqDeitar').value);
            const tempoDeitada = parseInt(document.getElementById('tempoDeitada').value);
            const usoTela = parseInt(document.getElementById('usoTela').value);
            const mandosTotais = parseInt(document.getElementById('mandosTotais').value);

            // Validações
            if (dadosSessoes.some(d => d.sessao === sessao)) {
                alert('Sessão já existe! Use um número único.');
                return;
            }
            if (frustracao < 0 || frustracao > 4 || freqDeitar < 0 || freqDeitar > 3 || usoTela < 0 || usoTela > 3) {
                alert('Valores fora do range permitido. Verifique os campos.');
                return;
            }

            // Adiciona à lista
            dadosSessoes.push({ sessao, frustracao, freqDeitar, tempoDeitada, usoTela, mandosTotais });
            salvarDados();
            atualizarLista();
            atualizarGrafico();
            this.reset(); // Limpa formulário
        });

        // Evento para limpar dados
        document.getElementById('limparDados').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                dadosSessoes = [];
                salvarDados();
                atualizarLista();
                atualizarGrafico();
            }
        });

        // Inicializa na carga da página
        carregarDados();
    </script>
</body>
</html>